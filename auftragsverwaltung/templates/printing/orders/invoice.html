{% extends "printing/base.html" %}

{% block title %}Rechnung {{ doc.number }}{% endblock %}

{% block inline_styles %}
/* Invoice-specific styles */
.address-block {
    margin-bottom: 24pt;
}

.font {
    font-family: Arial, sans-serif;
}

.address-block .sender {
    font-size: 6pt;
    border-bottom: 1pt solid #ccc;
    padding-bottom: 3pt;
    margin-bottom: 6pt;
}

.address-block .recipient {
    font-size: 10pt;
    line-height: 1.3;
}

.doc-header {
    margin-bottom: 16pt;
}

.doc-header h1 {
    font-size: 16pt;
    margin-bottom: 8pt;
}

.doc-meta-table {
    width: 100%;
    margin-bottom: 16pt;
    border: none;
}

.doc-meta-table td {
    border: none;
    padding: 2pt 8pt 2pt 0;
    font-size: 9pt;
}

.doc-meta-table .label {
    font-weight: bold;
    width: 150pt;
}

.header-text {
    margin: 16pt 0;
    font-size: 10pt;
}

.positions-table {
    margin: 16pt 0;
}

.positions-table thead th {
    background-color: #f5f5f5;
    font-size: 8pt;
    padding: 4pt 6pt;
}

.positions-table tbody td {
    font-size: 9pt;
    padding: 4pt 6pt;
    vertical-align: top;
}

.positions-table .col-pos { width: 30pt; text-align: center; }
.positions-table .col-qty { width: 70pt; text-align: right; }
.positions-table .col-desc { width: auto; }
.positions-table .col-price { width: 70pt; text-align: right; }
.positions-table .col-discount { width: 50pt; text-align: right; }
.positions-table .col-net { width: 80pt; text-align: right; }

.long-text {
    font-size: 8pt;
    color: #555;
    margin-top: 2pt;
    white-space: pre-wrap;
}

.totals-section {
    margin-top: 24pt;
    page-break-inside: avoid;
}

.totals-table {
    width: 100%;
    max-width: 400pt;
    margin-left: auto;
    border: none;
}

.totals-table td {
    border: none;
    padding: 3pt 8pt;
    font-size: 9pt;
}

.totals-table .label {
    text-align: right;
    font-weight: normal;
}

.totals-table .amount {
    text-align: right;
    font-weight: normal;
    width: 100pt;
}

.totals-table .total-row {
    border-top: 1pt solid #000;
    font-weight: bold;
    font-size: 10pt;
}

.tax-notes {
    margin-top: 16pt;
    padding: 8pt;
    background-color: #f9f9f9;
    border: 1pt solid #ddd;
    font-size: 9pt;
    page-break-inside: avoid;
}

.footer-text {
    margin-top: 16pt;
    font-size: 9pt;
    color: #555;
}

.payment-term {
    margin-top: 12pt;
    font-size: 9pt;
    font-weight: bold;
}

/* 4-Column Footer Styles */
.company-footer {
    margin-top: 24pt;
    padding-top: 16pt;
    border-top: 2pt solid #333;
    page-break-inside: avoid;
}

.footer-columns {
    display: table;
    width: 100%;
    table-layout: fixed;
}

.footer-column {
    display: table-cell;
    width: 25%;
    vertical-align: top;
    padding-right: 8pt;
    font-size: 7pt;
    line-height: 1.4;
}

.footer-column:last-child {
    padding-right: 0;
}

.footer-column-title {
    font-weight: bold;
    font-size: 8pt;
    margin-bottom: 6pt;
    color: #333;
}

.footer-item {
    margin-bottom: 3pt;
}

.footer-icon {
    display: inline-block;
    width: 12pt;
    color: #666;
}

/* Footer on every page (via @page) */
@page {
    @bottom-left {
        content: "{{ company.name }}";
        font-size: 7pt;
        color: #666;
    }
    @bottom-center {
        content: "Seite " counter(page) " von " counter(pages);
        font-size: 8pt;
        color: #666;
    }
    @bottom-right {
        content: "{{ doc.number }}";
        font-size: 7pt;
        color: #666;
    }
}

/* First page specific header */
@page :first {
    margin-top: 6cm; /* Space for address window */
}
{% endblock %}

{% block first_page_header %}
<table>
    <tr>
        <td style="width:50%">
            <!-- Address block positioned for window envelope -->
            <div class="address-block">
                <div class="sender">
                    {{ company.name }} &bull; {{ company.address_lines.0|default:"" }} &bull; {{ company.address_lines.1|default:"" }}
                </div>
                {% if customer %}
                <div class="recipient">
                    {% for line in customer.address_lines %}
                    {{ line }}<br>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </td>
        <td style="vertical-align: top;padding-left: 20mm;">
            <!-- Company Logo (top right) -->
            {% if company.logo_url %}
            <div style="text-align: right; margin-bottom: 12pt;">
                <img src="{{ company.logo_url }}" alt="Logo" style="max-width: 150pt; max-height: 80pt;">
            </div>
            {% endif %}
            
            <!-- Document metadata -->
            <table class="doc-meta-table">
                <tr>
                    <td class="label">Rechnungsnummer:</td>
                    <td>{{ doc.number }}</td>
                </tr>
                <tr>
                    <td class="label">Rechnungsdatum:</td>
                    <td>{{ doc.issue_date|date:"d.m.Y" }}</td>
                </tr>
                {% if doc.due_date %}
                <tr>
                    <td class="label">F√§lligkeitsdatum:</td>
                    <td>{{ doc.due_date|date:"d.m.Y" }}</td>
                </tr>
                {% endif %}
                {% if customer %}
                <tr>
                    <td class="label">Kunde:</td>
                    <td>{{ customer.debitor_number }}</td>
                </tr>
                {% endif %}
                {% if customer.vat_id %}
                <tr>
                    <td class="label">USt-IdNr. Kunde:</td>
                    <td>{{ customer.vat_id }}</td>
                </tr>
                {% endif %}
                {% if doc.reference_number %}
                <tr>
                    <td class="label">Referenznummer:</td>
                    <td>{{ doc.reference_number }}</td>
                </tr>
                {% endif %}
             
            </table>
        </td>
    </tr>
</table>





{% endblock %}

{% block content %}
<!-- Document header -->
<div class="doc-header">
    <h1>{{ doc.document_type_name|default:"Dokument" }}</h1>
    <p>{% if doc.subject %}{{ doc.subject }}{% endif %}</p>
</div>



<!-- Header text (from Quill editor) -->
{% if doc.header_html %}
<div class="header-text">
    {{ doc.header_html|safe }}
</div>
{% endif %}

<!-- Positions table -->
<table class="positions-table">
    <thead style="border-bottom: solid 2px;">
        <tr>
            <th class="col-pos">Pos.</th>
            <th class="col-qty">Menge</th>           
            <th class="col-desc">Beschreibung</th>
            <th class="col-price">Einzelpreis</th>
            <th class="col-discount">Rabatt</th>
            <th class="col-net">Gesamt netto</th>
        </tr>
    </thead>
    <tbody>
        {% for line in lines %}
        <tr>
            <td class="col-pos">{{ line.pos }}</td>
            <td class="col-qty">{{ line.qty|floatformat:2 }} {{ line.unit }}</td>            
            <td class="col-desc">
                {{ line.short_text }}
                {% if line.long_text %}
                <div class="long-text">{{ line.long_text }}</div>
                {% endif %}
            </td>
            <td class="col-price">{{ line.unit_price_net|floatformat:2 }} ‚Ç¨</td>
            <td class="col-discount">
                {% if line.discount_percent > 0 %}
                {{ line.discount_percent|floatformat:2 }}%
                {% else %}
                -
                {% endif %}
            </td>
            <td class="col-net">{{ line.net|floatformat:2 }} ‚Ç¨</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Totals section -->
<div class="totals-section">
    <table class="totals-table">
        {% if totals.net_19 > 0 %}
        <tr>
            <td class="label">Nettobetrag (19% MwSt.):</td>
            <td class="amount">{{ totals.net_19|floatformat:2 }} ‚Ç¨</td>
        </tr>
        <tr>
            <td class="label">Umsatzsteuer 19%:</td>
            <td class="amount">{{ totals.tax_19|floatformat:2 }} ‚Ç¨</td>
        </tr>
        {% endif %}
        {% if totals.net_7 > 0 %}
        <tr>
            <td class="label">Nettobetrag (7% MwSt.):</td>
            <td class="amount">{{ totals.net_7|floatformat:2 }} ‚Ç¨</td>
        </tr>
        <tr>
            <td class="label">Umsatzsteuer 7%:</td>
            <td class="amount">{{ totals.tax_7|floatformat:2 }} ‚Ç¨</td>
        </tr>
        {% endif %}
        {% if totals.net_0 > 0 %}
        <tr>
            <td class="label">Nettobetrag (0% MwSt.):</td>
            <td class="amount">{{ totals.net_0|floatformat:2 }} ‚Ç¨</td>
        </tr>
        {% endif %}
        <tr>
            <td class="label">Gesamtnettobetrag:</td>
            <td class="amount">{{ totals.net_total|floatformat:2 }} ‚Ç¨</td>
        </tr>
        <tr>
            <td class="label">Gesamtsteuerbetrag:</td>
            <td class="amount">{{ totals.tax_total|floatformat:2 }} ‚Ç¨</td>
        </tr>
        <tr class="total-row">
            <td class="label">Gesamtbruttobetrag:</td>
            <td class="amount">{{ totals.gross_total|floatformat:2 }} ‚Ç¨</td>
        </tr>
    </table>
</div>

<!-- Tax notes (EU/Reverse Charge) -->
{% if tax_notes.reverse_charge_text or tax_notes.export_text %}
<div class="tax-notes">
    {% if tax_notes.reverse_charge_text %}
    <p><strong>Hinweis:</strong> {{ tax_notes.reverse_charge_text }}</p>
    {% endif %}
    {% if tax_notes.export_text %}
    <p><strong>Hinweis:</strong> {{ tax_notes.export_text }}</p>
    {% endif %}
</div>
{% endif %}

<!-- Payment term -->
{% if doc.paymentterm_text %}
<div class="payment-term">
    {{ doc.paymentterm_text }}
</div>
{% endif %}

<!-- Footer text (from Quill editor) -->
{% if doc.footer_html %}
<div class="footer-text">
    {{ doc.footer_html|safe }}
</div>
{% endif %}

<!-- Public notes -->
{% if doc.notes_public %}
<div class="footer-text">
    <strong>Hinweise:</strong><br>
    {{ doc.notes_public }}
</div>
{% endif %}

<!-- Company footer information -->
<div class="company-footer">
    <div class="footer-columns">
        <!-- Column 1: Name & Address -->
        <div class="footer-column">
            <div class="footer-column-title">
                <span class="footer-icon">üè¢</span> Anschrift
            </div>
            {% if company.name %}
            <div class="footer-item"><strong>{{ company.name }}</strong></div>
            {% endif %}
            {% if company.address_lines.0 %}
            <div class="footer-item">{{ company.address_lines.0 }}</div>
            {% endif %}
            {% if company.address_lines.1 %}
            <div class="footer-item">{{ company.address_lines.1 }}</div>
            {% endif %}
            {% if company.address_lines.2 %}
            <div class="footer-item">{{ company.address_lines.2 }}</div>
            {% endif %}
        </div>
        
        <!-- Column 2: Contact Details -->
        <div class="footer-column">
            <div class="footer-column-title">
                <span class="footer-icon">üìû</span> Kontakt
            </div>
            {% if company.phone %}
            <div class="footer-item">
                <span class="footer-icon">‚òé</span> {{ company.phone }}
            </div>
            {% endif %}
            {% if company.fax %}
            <div class="footer-item">
                <span class="footer-icon">üì†</span> {{ company.fax }}
            </div>
            {% endif %}
            {% if company.email %}
            <div class="footer-item">
                <span class="footer-icon">‚úâ</span> {{ company.email }}
            </div>
            {% endif %}
            {% if company.internet %}
            <div class="footer-item">
                <span class="footer-icon">üåê</span> {{ company.internet }}
            </div>
            {% endif %}
        </div>
        
        <!-- Column 3: Legal Information -->
        <div class="footer-column">
            <div class="footer-column-title">
                <span class="footer-icon">‚öñ</span> Rechtliches
            </div>
            {% if company.tax_number %}
            <div class="footer-item">Steuernr.: {{ company.tax_number }}</div>
            {% endif %}
            {% if company.vat_id %}
            <div class="footer-item">USt-IdNr.: {{ company.vat_id }}</div>
            {% endif %}
            {% if company.managing_director %}
            <div class="footer-item">GF: {{ company.managing_director }}</div>
            {% endif %}
            {% if company.commercial_register %}
            <div class="footer-item">{{ company.commercial_register }}</div>
            {% endif %}
        </div>
        
        <!-- Column 4: Bank Details -->
        <div class="footer-column">
            <div class="footer-column-title">
                <span class="footer-icon">üè¶</span> Bankverbindung
            </div>
            {% if company.bank_name %}
            <div class="footer-item">{{ company.bank_name }}</div>
            {% endif %}
            {% if company.iban %}
            <div class="footer-item">IBAN: {{ company.iban }}</div>
            {% endif %}
            {% if company.bic %}
            <div class="footer-item">BIC: {{ company.bic }}</div>
            {% endif %}
            {% if company.account_holder and company.account_holder != company.name %}
            <div class="footer-item">Inhaber: {{ company.account_holder }}</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
