{% extends "vermietung/layouts/detail_layout.html" %}

{% block title %}Adresse: {{ adresse.full_name }} - Domus{% endblock %}

{% block page_title %}Adresse: {{ adresse.full_name }}{% endblock %}

{% block page_actions %}
<a href="{% url 'vermietung:adresse_edit' adresse.pk %}" class="btn btn-warning">
    <i class="bi bi-pencil"></i> Bearbeiten
</a>
<button type="button" class="btn btn-danger" onclick="confirmDelete()">
    <i class="bi bi-trash"></i> Löschen
</button>
<a href="{% url 'vermietung:adresse_list' %}" class="btn btn-secondary">
    <i class="bi bi-arrow-left"></i> Zurück zur Liste
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-person-badge"></i> Adressdaten</h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Anrede:</div>
                    <div class="col-md-8">{{ adresse.get_anrede_display|default:"-" }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Name:</div>
                    <div class="col-md-8"><strong>{{ adresse.name }}</strong></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Firma:</div>
                    <div class="col-md-8">{{ adresse.firma|default:"-" }}</div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Adresse</h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Straße:</div>
                    <div class="col-md-8">{{ adresse.strasse }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">PLZ:</div>
                    <div class="col-md-8">{{ adresse.plz }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Ort:</div>
                    <div class="col-md-8">{{ adresse.ort }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Land:</div>
                    <div class="col-md-8">{{ adresse.land }}</div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-telephone"></i> Kontaktdaten</h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Telefon:</div>
                    <div class="col-md-8">{{ adresse.telefon|default:"-" }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Mobil:</div>
                    <div class="col-md-8">{{ adresse.mobil|default:"-" }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">E-Mail:</div>
                    <div class="col-md-8">
                        {% if adresse.email %}
                        <a href="mailto:{{ adresse.email }}">{{ adresse.email }}</a>
                        {% else %}
                        -
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Information</h5>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-2">
                    <strong>Adress-Typ:</strong> Adresse
                </p>
                <p class="small text-muted mb-0">
                    <strong>ID:</strong> {{ adresse.pk }}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Detail Tabs Section -->
{% with entity_type_label="diese Adresse" %}
<div class="row mt-4">
    <div class="col-12">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="detailTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" 
                        id="kontakte-tab" 
                        data-bs-toggle="tab" 
                        data-bs-target="#kontakte" 
                        type="button" 
                        role="tab" 
                        aria-controls="kontakte"
                        aria-selected="true"
                        data-tab-id="kontakte">
                    <i class="bi bi-person-lines-fill"></i> Kontakte
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" 
                        id="dokumente-tab" 
                        data-bs-toggle="tab" 
                        data-bs-target="#dokumente" 
                        type="button" 
                        role="tab" 
                        aria-controls="dokumente"
                        aria-selected="false"
                        data-tab-id="dokumente">
                    <i class="bi bi-file-earmark-text"></i> Dokumente
                </button>
            </li>
            {% if adresse.bemerkung %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" 
                        id="bemerkung-tab" 
                        data-bs-toggle="tab" 
                        data-bs-target="#bemerkung" 
                        type="button" 
                        role="tab" 
                        aria-controls="bemerkung"
                        aria-selected="false"
                        data-tab-id="bemerkung">
                    <i class="bi bi-chat-left-text"></i> Bemerkung
                </button>
            </li>
            {% endif %}
        </ul>

        <!-- Tab Content -->
        <div class="tab-content card" id="detailTabsContent">
            <div class="tab-pane fade show active" 
                 id="kontakte" 
                 role="tabpanel" 
                 aria-labelledby="kontakte-tab">
                <div class="card-body">
                    {% include "vermietung/kontakte/_tab_content.html" with adresse=adresse %}
                </div>
            </div>
            <div class="tab-pane fade" 
                 id="dokumente" 
                 role="tabpanel" 
                 aria-labelledby="dokumente-tab">
                <div class="card-body">
                    {% include "vermietung/dokumente/_tab_content.html" %}
                </div>
            </div>
            {% if adresse.bemerkung %}
            <div class="tab-pane fade" 
                 id="bemerkung" 
                 role="tabpanel" 
                 aria-labelledby="bemerkung-tab">
                <div class="card-body">
                    {% include "vermietung/bemerkungen/_tab_content.html" %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endwith %}

<!-- Document Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">
                    <i class="bi bi-upload"></i> Dokument hochladen
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'vermietung:dokument_upload' 'adresse' adresse.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="id_file" class="form-label">Datei *</label>
                        <input type="file" class="form-control" id="id_file" name="file" required accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.docx">
                        <div class="form-text">
                            Erlaubte Dateitypen: PDF, PNG, JPG/JPEG, GIF, WebP, DOCX. Maximale Größe: 10 MB
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="id_beschreibung" class="form-label">Beschreibung (optional)</label>
                        <textarea class="form-control" id="id_beschreibung" name="beschreibung" rows="3" placeholder="Optional: Beschreibung des Dokuments"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload"></i> Hochladen
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="deleteForm" method="post" action="{% url 'vermietung:adresse_delete' adresse.pk %}" style="display: none;">
    {% csrf_token %}
</form>

<form id="deleteDokumentForm" method="post" action="" style="display: none;">
    {% csrf_token %}
</form>

<form id="deleteKontaktForm" method="post" action="" style="display: none;">
    {% csrf_token %}
</form>
{% endblock %}

{% block extra_js %}
<script>
// Tab localStorage persistence
(function() {
    const pathname = window.location.pathname;
    const storageKey = `kmgr:detailTabs:${pathname}`;
    
    const tabButtons = document.querySelectorAll('#detailTabs button[data-bs-toggle="tab"]');
    const tabButtonsArray = Array.from(tabButtons);
    
    function restoreActiveTab() {
        const savedTabId = localStorage.getItem(storageKey);
        
        if (savedTabId) {
            const savedButton = tabButtonsArray.find(btn => btn.getAttribute('data-tab-id') === savedTabId);
            
            if (savedButton) {
                const tab = new bootstrap.Tab(savedButton);
                tab.show();
            }
        }
    }
    
    tabButtons.forEach(button => {
        button.addEventListener('shown.bs.tab', function(event) {
            const tabId = event.target.getAttribute('data-tab-id');
            localStorage.setItem(storageKey, tabId);
        });
    });
    
    document.addEventListener('DOMContentLoaded', restoreActiveTab);
})();

function confirmDelete() {
    var kontakteCount = {{ adresse.kontakte.count }};
    var message = 'Möchten Sie die Adresse "{{ adresse.full_name }}" wirklich löschen?';
    
    if (kontakteCount > 0) {
        message += '\n\nACHTUNG: Es ' + (kontakteCount === 1 ? 'ist 1 Kontakt' : 'sind ' + kontakteCount + ' Kontakte') + ' mit dieser Adresse verknüpft, ' + (kontakteCount === 1 ? 'der' : 'die') + ' ebenfalls gelöscht ' + (kontakteCount === 1 ? 'wird' : 'werden') + '.';
    }
    
    if (confirm(message)) {
        document.getElementById('deleteForm').submit();
    }
}

function confirmDeleteDokument(dokumentId, filename) {
    if (confirm('Möchten Sie das Dokument "' + filename + '" wirklich löschen?\n\nDieser Vorgang kann nicht rückgängig gemacht werden.')) {
        var form = document.getElementById('deleteDokumentForm');
        form.action = "{% url 'vermietung:dokument_delete' 0 %}".replace('/0/', '/' + dokumentId + '/');
        form.submit();
    }
}

function confirmDeleteKontakt(kontaktId, kontaktName) {
    if (confirm('Möchten Sie den Kontakt "' + kontaktName + '" wirklich löschen?\n\nDieser Vorgang kann nicht rückgängig gemacht werden.')) {
        var form = document.getElementById('deleteKontaktForm');
        form.action = "{% url 'vermietung:kontakt_delete' 0 %}".replace('/0/', '/' + kontaktId + '/');
        form.submit();
    }
}
</script>
{% endblock %}
