{% extends "vermietung/vermietung_base.html" %}

{% block title %}Aktivitäten - Kanban - K-Manager v1.0{% endblock %}

{% block page_title %}Aktivitäten{% endblock %}

{% block page_actions %}
<div class="btn-group me-2" role="group" aria-label="Aktivitäten-Filter" id="filter-mode-buttons">
    <button type="button" data-filter="responsible" 
       class="btn btn-sm filter-mode-btn {% if filter_mode == 'responsible' %}btn-primary{% else %}btn-outline-primary{% endif %}">
        <i class="bi bi-person-check"></i> Verantwortlich
    </button>
    <button type="button" data-filter="created" 
       class="btn btn-sm filter-mode-btn {% if filter_mode == 'created' %}btn-primary{% else %}btn-outline-primary{% endif %}">
        <i class="bi bi-plus-circle"></i> Erstellt
    </button>
    <button type="button" data-filter="all" 
       class="btn btn-sm filter-mode-btn {% if filter_mode == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
        <i class="bi bi-list-ul"></i> Alle
    </button>
</div>
<div class="form-check form-switch me-2" style="display: inline-block; padding-left: 2.5em;">
    <input class="form-check-input" type="checkbox" id="completedFilterCheckbox" {% if completed_filter %}checked{% endif %}>
    <label class="form-check-label" for="completedFilterCheckbox">
        Erledigt
    </label>
</div>
<a href="{% url 'vermietung:aktivitaet_list' %}" class="btn btn-outline-secondary">
    <i class="bi bi-list-ul"></i> Listenansicht
</a>
<a href="{% url 'vermietung:aktivitaet_create' %}" class="btn btn-primary">
    <i class="bi bi-plus-circle"></i> Neue Aktivität
</a>
{% endblock %}

{% block extra_css %}
<style>
.kanban-container {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding-bottom: 1rem;
}

.kanban-column {
    flex: 1;
    min-width: 300px;
    background: var(--bs-gray-900);
    border-radius: 0.5rem;
    padding: 1rem;
}

.kanban-header {
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--bs-gray-700);
}

.kanban-card {
    background: var(--bs-gray-800);
    border: 1px solid var(--bs-gray-700);
    border-radius: 0.375rem;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

.kanban-card:hover {
    border-color: var(--bs-primary);
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3);
}

.kanban-card-title {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.kanban-card-meta {
    font-size: 0.875rem;
    color: var(--bs-gray-400);
}

.priority-badge {
    font-size: 0.75rem;
}

.context-icon {
    font-size: 0.875rem;
}

.badge-status-OFFEN {
    background-color: var(--bs-info);
}

.badge-status-IN_BEARBEITUNG {
    background-color: var(--bs-warning);
    color: var(--bs-dark);
}

.badge-status-ERLEDIGT {
    background-color: var(--bs-success);
}

.badge-status-ABGEBROCHEN {
    background-color: var(--bs-danger);
}
</style>
{% endblock %}

{% block content %}
<!-- Hidden data attributes for JavaScript to safely access server-side values -->
<div id="filter-state-data" 
     data-filter-mode="{{ filter_mode }}" 
     data-completed-filter="{% if completed_filter %}true{% else %}false{% endif %}" 
     style="display: none;"></div>

<div class="alert alert-info mb-3" role="alert">
    <i class="bi bi-info-circle" aria-hidden="true"></i>
    <strong>Tipp:</strong> Aufgaben können per Drag &amp; Drop in eine andere Spalte gezogen werden, um den Status zu ändern.
</div>

<div class="kanban-container">
    <!-- Offen Column -->
    <div class="kanban-column">
        <div class="kanban-header">
            <i class="bi bi-circle"></i> Offen
            <span class="badge bg-info ms-2">{{ aktivitaeten_offen.count }}</span>
        </div>
        <div class="kanban-cards" data-status="OFFEN">
            {% for aktivitaet in aktivitaeten_offen %}
            {% include "vermietung/aktivitaeten/_kanban_card.html" with aktivitaet=aktivitaet %}
            {% empty %}
            <div class="text-muted text-center py-3">
                <small>Keine offenen Aktivitäten</small>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- In Bearbeitung Column -->
    <div class="kanban-column">
        <div class="kanban-header">
            <i class="bi bi-hourglass-split"></i> In Bearbeitung
            <span class="badge bg-warning text-dark ms-2">{{ aktivitaeten_in_bearbeitung.count }}</span>
        </div>
        <div class="kanban-cards" data-status="IN_BEARBEITUNG">
            {% for aktivitaet in aktivitaeten_in_bearbeitung %}
            {% include "vermietung/aktivitaeten/_kanban_card.html" with aktivitaet=aktivitaet %}
            {% empty %}
            <div class="text-muted text-center py-3">
                <small>Keine Aktivitäten in Bearbeitung</small>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Erledigt Column -->
    <div class="kanban-column">
        <div class="kanban-header">
            <i class="bi bi-check-circle"></i> Erledigt
            <span class="badge bg-success ms-2">{{ aktivitaeten_erledigt.count }}</span>
        </div>
        <div class="kanban-cards" data-status="ERLEDIGT">
            {% for aktivitaet in aktivitaeten_erledigt %}
            {% include "vermietung/aktivitaeten/_kanban_card.html" with aktivitaet=aktivitaet %}
            {% empty %}
            <div class="text-muted text-center py-3">
                <small>Keine erledigten Aktivitäten</small>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Abgebrochen Column -->
    <div class="kanban-column">
        <div class="kanban-header">
            <i class="bi bi-x-circle"></i> Abgebrochen
            <span class="badge bg-danger ms-2">{{ aktivitaeten_abgebrochen.count }}</span>
        </div>
        <div class="kanban-cards" data-status="ABGEBROCHEN">
            {% for aktivitaet in aktivitaeten_abgebrochen %}
            {% include "vermietung/aktivitaeten/_kanban_card.html" with aktivitaet=aktivitaet %}
            {% empty %}
            <div class="text-muted text-center py-3">
                <small>Keine abgebrochenen Aktivitäten</small>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // localStorage key for persisting aktivitaeten filters
    const STORAGE_KEY = 'aktivitaeten_kanban_filters';
    
    // Get server-side values safely from data attributes
    const filterStateData = document.getElementById('filter-state-data');
    const initialFilterMode = filterStateData.dataset.filterMode;
    const initialCompletedFilter = filterStateData.dataset.completedFilter === 'true';
    
    // Track current filter mode (updated when buttons are clicked)
    let currentFilterMode = initialFilterMode;
    
    // Get filter elements
    const filterButtons = document.querySelectorAll('.filter-mode-btn');
    const completedCheckbox = document.getElementById('completedFilterCheckbox');
    
    // Load filters from localStorage on page load
    function loadFiltersFromStorage() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const filters = JSON.parse(stored);
                // Only apply from localStorage if no URL params present
                const urlParams = new URLSearchParams(window.location.search);
                if (!urlParams.has('filter') && !urlParams.has('completed')) {
                    // Redirect if stored filters differ from current state
                    if (filters.filter_mode !== initialFilterMode || filters.completed !== initialCompletedFilter) {
                        window.location.href = buildFilterUrl(filters.filter_mode, filters.completed);
                        return true;
                    }
                }
            }
        } catch (e) {
            console.error('Error loading filters from localStorage:', e);
        }
        return false;
    }
    
    // Save filters to localStorage
    function saveFiltersToStorage(filterMode, completed) {
        try {
            const filters = {
                filter_mode: filterMode,
                completed: completed
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(filters));
        } catch (e) {
            console.error('Error saving filters to localStorage:', e);
        }
    }
    
    // Build URL with current filters
    function buildFilterUrl(filterMode, completed) {
        const url = new URL(window.location.href);
        url.searchParams.set('filter', filterMode);
        url.searchParams.set('completed', completed ? 'true' : 'false');
        return url.toString();
    }
    
    // Handle filter mode button clicks
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const filterMode = this.dataset.filter;
            currentFilterMode = filterMode; // Update tracked mode
            const completed = completedCheckbox.checked;
            saveFiltersToStorage(filterMode, completed);
            window.location.href = buildFilterUrl(filterMode, completed);
        });
    });
    
    // Handle completed checkbox changes
    completedCheckbox.addEventListener('change', function() {
        const completed = this.checked;
        // Use tracked current filter mode
        saveFiltersToStorage(currentFilterMode, completed);
        window.location.href = buildFilterUrl(currentFilterMode, completed);
    });
    
    // Try to load filters from localStorage
    const redirected = loadFiltersFromStorage();
    if (redirected) {
        return; // Don't initialize drag-drop if we're redirecting
    }
    
    // Save current state to localStorage
    saveFiltersToStorage(initialFilterMode, initialCompletedFilter);
    
    // Add drag and drop functionality
    const cards = document.querySelectorAll('.kanban-card');
    const columns = document.querySelectorAll('.kanban-cards');
    
    cards.forEach(card => {
        card.setAttribute('draggable', 'true');
        
        card.addEventListener('dragstart', function(e) {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            e.dataTransfer.setData('aktivitaet-id', this.dataset.aktivitaetId);
            this.classList.add('opacity-50');
        });
        
        card.addEventListener('dragend', function(e) {
            this.classList.remove('opacity-50');
        });
        
        // Click to edit
        card.addEventListener('click', function(e) {
            // Only if not dragging
            if (!this.classList.contains('opacity-50')) {
                const aktivitaetId = this.dataset.aktivitaetId;
                window.location.href = `/vermietung/aktivitaeten/${aktivitaetId}/bearbeiten/`;
            }
        });
    });
    
    columns.forEach(column => {
        column.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('bg-primary', 'bg-opacity-10');
        });
        
        column.addEventListener('dragleave', function(e) {
            this.classList.remove('bg-primary', 'bg-opacity-10');
        });
        
        column.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('bg-primary', 'bg-opacity-10');
            
            const aktivitaetId = e.dataTransfer.getData('aktivitaet-id');
            const newStatus = this.dataset.status;
            
            // Build URL using aktivitaet ID
            const updateUrl = '{% url "vermietung:aktivitaet_update_status" 0 %}'.replace('/0/', '/' + aktivitaetId + '/');
            
            // Update status via AJAX
            fetch(updateUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `status=${newStatus}`
            })
            .then(response => {
                if (!response.ok) {
                    // Handle HTTP errors
                    return response.json().then(data => {
                        throw new Error(data.error || 'Status konnte nicht aktualisiert werden');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Reload page to show updated status
                    location.reload();
                } else {
                    // Show error and reload to restore UI state
                    alert('Fehler: ' + (data.error || 'Status konnte nicht aktualisiert werden'));
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Fehler beim Aktualisieren des Status: ' + error.message);
                // Reload page to restore consistent state
                location.reload();
            });
        });
    });
});
</script>
{% endblock %}
