{% extends "vermietung/vermietung_base.html" %}

{% block title %}Dashboard - Vermietung - Domus{% endblock %}

{% block page_title %}
<i class="bi bi-speedometer2"></i> Vermietung Dashboard
{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>Willkommen!</strong> Sie sind angemeldet als <strong>{{ request.user.username }}</strong>
            {% if request.user.is_staff %}
                (Administrator)
            {% else %}
                (Vermietung)
            {% endif %}
        </div>
    </div>
</div>

<!-- KPI Cards -->
<div class="row mb-4">
    <div class="col-md-4 col-lg-3 mb-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Gesamt Objekte</p>
                        <h3 class="mb-0">{{ total_mietobjekte }}</h3>
                    </div>
                    <div class="display-6 text-primary">
                        <i class="bi bi-house-door"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="{% url 'vermietung:mietobjekt_list' %}" class="text-decoration-none">
                    <small>Alle anzeigen <i class="bi bi-arrow-right"></i></small>
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-3 mb-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Verfügbare Mieteinheiten</p>
                        <h3 class="mb-0">{{ verfuegbare_einheiten_gesamt }}</h3>
                    </div>
                    <div class="display-6 text-warning">
                        <i class="bi bi-key"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="#verfuegbare-einheiten" class="text-decoration-none">
                    <small>Details anzeigen <i class="bi bi-arrow-down"></i></small>
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-3 mb-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Aktive Verträge</p>
                        <h3 class="mb-0">{{ active_vertraege }}</h3>
                    </div>
                    <div class="display-6 text-success">
                        <i class="bi bi-file-earmark-check"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="{% url 'vermietung:vertrag_list' %}?status=active" class="text-decoration-none">
                    <small>Aktive anzeigen <i class="bi bi-arrow-right"></i></small>
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-3 mb-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Offene Aktivitäten</p>
                        <h3 class="mb-0">{{ offene_aktivitaeten }}</h3>
                    </div>
                    <div class="display-6 text-danger">
                        <i class="bi bi-list-check"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="{% url 'vermietung:aktivitaet_list' %}?status=OFFEN" class="text-decoration-none">
                    <small>Offene anzeigen <i class="bi bi-arrow-right"></i></small>
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-3 mb-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Kunden</p>
                        <h3 class="mb-0">{{ total_kunden }}</h3>
                    </div>
                    <div class="display-6 text-info">
                        <i class="bi bi-people"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="{% url 'vermietung:kunde_list' %}" class="text-decoration-none">
                    <small>Alle anzeigen <i class="bi bi-arrow-right"></i></small>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-4 text-primary mb-3">
                    <i class="bi bi-house-door"></i>
                </div>
                <h5 class="card-title">Mietobjekte</h5>
                <p class="card-text text-muted">Verwalten Sie Ihre Immobilien</p>
                <a href="{% url 'vermietung:mietobjekt_list' %}" class="btn btn-primary">
                    <i class="bi bi-arrow-right-circle"></i> Anzeigen
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-4 text-success mb-3">
                    <i class="bi bi-file-earmark-text"></i>
                </div>
                <h5 class="card-title">Verträge</h5>
                <p class="card-text text-muted">Mietverträge verwalten</p>
                <a href="{% url 'vermietung:vertrag_list' %}" class="btn btn-success">
                    <i class="bi bi-arrow-right-circle"></i> Anzeigen
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-4 text-warning mb-3">
                    <i class="bi bi-people"></i>
                </div>
                <h5 class="card-title">Kunden</h5>
                <p class="card-text text-muted">Mieter und Kontakte</p>
                <a href="{% url 'vermietung:kunde_list' %}" class="btn btn-warning">
                    <i class="bi bi-arrow-right-circle"></i> Anzeigen
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-4 text-info mb-3">
                    <i class="bi bi-clipboard-check"></i>
                </div>
                <h5 class="card-title">Übergaben</h5>
                <p class="card-text text-muted">Übergabeprotokolle</p>
                <a href="{% url 'vermietung:uebergabeprotokoll_list' %}" class="btn btn-info">
                    <i class="bi bi-arrow-right-circle"></i> Anzeigen
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Available Rental Units by Object -->
<div class="row mb-4" id="verfuegbare-einheiten">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-key"></i> Verfügbare Mietobjekte
                </h5>
            </div>
            <div class="card-body">
                {% if mietobjekte_mit_einheiten %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Mietobjekt</th>
                                    <th>Typ</th>
                                    <th>Standort</th>
                                    <th class="text-center">Gesamt Einheiten</th>
                                    <th class="text-center">Gebuchte Einheiten</th>
                                    <th class="text-center">Verfügbare Einheiten</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in mietobjekte_mit_einheiten %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'vermietung:mietobjekt_detail' item.objekt.pk %}" class="text-decoration-none">
                                                {{ item.objekt.name }}
                                            </a>
                                        </td>
                                        <td>{{ item.objekt.get_type_display }}</td>
                                        <td>{{ item.objekt.standort.ort }}</td>
                                        <td class="text-center">{{ item.gesamt_einheiten }}</td>
                                        <td class="text-center">
                                            {% if item.gebuchte_einheiten > 0 %}
                                                <span class="badge bg-secondary">{{ item.gebuchte_einheiten }}</span>
                                            {% else %}
                                                <span class="text-muted">0</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if item.verfuegbare_einheiten > 0 %}
                                                <span class="badge bg-success">{{ item.verfuegbare_einheiten }}</span>
                                            {% else %}
                                                <span class="badge bg-danger">0</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{% url 'vermietung:mietobjekt_detail' item.objekt.pk %}" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i> Details
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">Keine Mietobjekte vorhanden.</p>
                {% endif %}
            </div>
            <div class="card-footer">
                <a href="{% url 'vermietung:mietobjekt_list' %}" class="text-decoration-none">
                    Alle Mietobjekte anzeigen <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Recently Created Contracts -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> Zuletzt angelegte Verträge
                </h5>
            </div>
            <div class="card-body">
                {% if recent_vertraege %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Vertragsnummer</th>
                                    <th>Mietobjekt</th>
                                    <th>Mieter</th>
                                    <th>Start</th>
                                    <th>Status</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vertrag in recent_vertraege %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'vermietung:vertrag_detail' vertrag.pk %}" class="text-decoration-none">
                                                {{ vertrag.vertragsnummer }}
                                            </a>
                                        </td>
                                        <td>{{ vertrag.mietobjekt.name }}</td>
                                        <td>{{ vertrag.mieter.full_name }}</td>
                                        <td>{{ vertrag.start|date:"d.m.Y" }}</td>
                                        <td>
                                            {% if vertrag.status == 'active' %}
                                                <span class="badge bg-success">{{ vertrag.get_status_display }}</span>
                                            {% elif vertrag.status == 'draft' %}
                                                <span class="badge bg-secondary">{{ vertrag.get_status_display }}</span>
                                            {% elif vertrag.status == 'ended' %}
                                                <span class="badge bg-dark">{{ vertrag.get_status_display }}</span>
                                            {% elif vertrag.status == 'cancelled' %}
                                                <span class="badge bg-danger">{{ vertrag.get_status_display }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{% url 'vermietung:vertrag_detail' vertrag.pk %}" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i> Details
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">Keine Verträge vorhanden.</p>
                {% endif %}
            </div>
            <div class="card-footer">
                <a href="{% url 'vermietung:vertrag_list' %}" class="text-decoration-none">
                    Alle Verträge anzeigen <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Expiring Contracts -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle"></i> Auslaufende Verträge (nächste 60 Tage)
                </h5>
            </div>
            <div class="card-body">
                {% if expiring_vertraege %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Vertragsnummer</th>
                                    <th>Mietobjekt</th>
                                    <th>Mieter</th>
                                    <th>Enddatum</th>
                                    <th>Verbleibende Tage</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vertrag in expiring_vertraege %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'vermietung:vertrag_detail' vertrag.pk %}" class="text-decoration-none">
                                                {{ vertrag.vertragsnummer }}
                                            </a>
                                        </td>
                                        <td>{{ vertrag.mietobjekt.name }}</td>
                                        <td>{{ vertrag.mieter.full_name }}</td>
                                        <td>{{ vertrag.ende|date:"d.m.Y" }}</td>
                                        <td>
                                            {% with days_remaining=vertrag.ende|timeuntil %}
                                                {% if "0 minutes" in days_remaining or "0 Minuten" in days_remaining %}
                                                    <span class="badge bg-danger">Heute</span>
                                                {% else %}
                                                    {{ days_remaining }}
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                        <td>
                                            <a href="{% url 'vermietung:vertrag_detail' vertrag.pk %}" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i> Details
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">Keine auslaufenden Verträge in den nächsten 60 Tagen.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
