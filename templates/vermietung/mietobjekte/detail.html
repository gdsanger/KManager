{% extends "vermietung/vermietung_base.html" %}

{% block title %}Mietobjekt: {{ mietobjekt.name }} - K-Manager v1.0{% endblock %}

{% block page_title %}Mietobjekt: {{ mietobjekt.name }}{% endblock %}

{% block page_actions %}
<a href="{% url 'vermietung:mietobjekt_edit' mietobjekt.pk %}" class="btn btn-warning">
    <i class="bi bi-pencil"></i> Bearbeiten
</a>
<button type="button" class="btn btn-danger" onclick="confirmDelete()">
    <i class="bi bi-trash"></i> Löschen
</button>
<a href="{% url 'vermietung:mietobjekt_list' %}" class="btn btn-secondary">
    <i class="bi bi-arrow-left"></i> Zurück zur Liste
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Basic Information -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-building"></i> Objektdaten</h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Name:</div>
                    <div class="col-md-8"><strong>{{ mietobjekt.name }}</strong></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Typ:</div>
                    <div class="col-md-8">{{ mietobjekt.get_type_display }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Beschreibung:</div>
                    <div class="col-md-8">{{ mietobjekt.beschreibung }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Status:</div>
                    <div class="col-md-8">
                        {% if mietobjekt.verfuegbar %}
                            <span class="badge bg-success"><i class="bi bi-check-circle"></i> Verfügbar</span>
                        {% else %}
                            <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Belegt</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Location -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Standort</h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Adresse:</div>
                    <div class="col-md-8">
                        {{ mietobjekt.standort.strasse }}<br>
                        {{ mietobjekt.standort.plz }} {{ mietobjekt.standort.ort }}<br>
                        {{ mietobjekt.standort.land }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Dimensions -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-rulers"></i> Abmessungen</h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Fläche:</div>
                    <div class="col-md-8">{{ mietobjekt.fläche|default:"-" }} {% if mietobjekt.fläche %}m²{% endif %}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Höhe:</div>
                    <div class="col-md-8">{{ mietobjekt.höhe|default:"-" }} {% if mietobjekt.höhe %}m{% endif %}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Breite:</div>
                    <div class="col-md-8">{{ mietobjekt.breite|default:"-" }} {% if mietobjekt.breite %}m{% endif %}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Tiefe:</div>
                    <div class="col-md-8">{{ mietobjekt.tiefe|default:"-" }} {% if mietobjekt.tiefe %}m{% endif %}</div>
                </div>
            </div>
        </div>

        <!-- Prices -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-currency-euro"></i> Preise & Kosten</h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Mietpreis:</div>
                    <div class="col-md-8"><strong>{{ mietobjekt.mietpreis }} €</strong></div>
                </div>
                {% if mietobjekt.qm_mietpreis %}
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Preis pro m²:</div>
                    <div class="col-md-8">{{ mietobjekt.qm_mietpreis }} €/m²</div>
                </div>
                {% endif %}
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Nebenkosten:</div>
                    <div class="col-md-8">{{ mietobjekt.nebenkosten|default:"-" }} {% if mietobjekt.nebenkosten %}€{% endif %}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4 text-muted">Kaution:</div>
                    <div class="col-md-8">{{ mietobjekt.kaution|default:"-" }} {% if mietobjekt.kaution %}€{% endif %}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Information</h5>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-2">
                    <strong>Objekt-ID:</strong> {{ mietobjekt.pk }}
                </p>
                <p class="small text-muted mb-0">
                    <strong>Typ:</strong> {{ mietobjekt.get_type_display }}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Related Data Tabs -->
<div class="row mt-4">
    <div class="col-12">
        <h4 class="mb-3">Zugehörige Informationen</h4>
        <ul class="nav nav-tabs" id="relatedTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="vertraege-tab" data-bs-toggle="tab" data-bs-target="#vertraege" type="button" role="tab">
                    <i class="bi bi-file-earmark-text"></i> Verträge ({{ vertraege_page_obj.paginator.count }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="uebergaben-tab" data-bs-toggle="tab" data-bs-target="#uebergaben" type="button" role="tab">
                    <i class="bi bi-clipboard-check"></i> Übergaben ({{ uebergaben_page_obj.paginator.count }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bilder-tab" data-bs-toggle="tab" data-bs-target="#bilder" type="button" role="tab">
                    <i class="bi bi-images"></i> Bilder ({{ bilder_page_obj.paginator.count }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dokumente-tab" data-bs-toggle="tab" data-bs-target="#dokumente" type="button" role="tab">
                    <i class="bi bi-file-earmark"></i> Dokumente ({{ dokumente_page_obj.paginator.count }})
                </button>
            </li>
        </ul>
        <div class="tab-content card" id="relatedTabsContent">
            <!-- Contracts Tab -->
            <div class="tab-pane fade show active p-3" id="vertraege" role="tabpanel">
                {% if vertraege_page_obj %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Vertragsnr.</th>
                                    <th>Mieter</th>
                                    <th>Zeitraum</th>
                                    <th>Miete</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vertrag in vertraege_page_obj %}
                                <tr>
                                    <td>{{ vertrag.vertragsnummer }}</td>
                                    <td>{{ vertrag.mieter.full_name }}</td>
                                    <td>
                                        {{ vertrag.start|date:"d.m.Y" }} - 
                                        {% if vertrag.ende %}{{ vertrag.ende|date:"d.m.Y" }}{% else %}<em>offen</em>{% endif %}
                                    </td>
                                    <td>{{ vertrag.miete }} €</td>
                                    <td>
                                        {% if vertrag.status == 'active' %}
                                            <span class="badge bg-success">{{ vertrag.get_status_display }}</span>
                                        {% elif vertrag.status == 'draft' %}
                                            <span class="badge bg-secondary">{{ vertrag.get_status_display }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ vertrag.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        <i class="bi bi-inbox"></i> Keine Verträge vorhanden
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination for Contracts -->
                    {% if vertraege_page_obj.has_other_pages %}
                    <nav aria-label="Verträge Pagination">
                        <ul class="pagination pagination-sm">
                            {% if vertraege_page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?vertraege_page={{ vertraege_page_obj.previous_page_number }}#vertraege">Zurück</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Zurück</span>
                            </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">Seite {{ vertraege_page_obj.number }} von {{ vertraege_page_obj.paginator.num_pages }}</span>
                            </li>
                            
                            {% if vertraege_page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?vertraege_page={{ vertraege_page_obj.next_page_number }}#vertraege">Weiter</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Weiter</span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% endif %}
            </div>
            
            <!-- Handover Protocols Tab -->
            <div class="tab-pane fade p-3" id="uebergaben" role="tabpanel">
                {% if uebergaben_page_obj %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Typ</th>
                                    <th>Vertrag</th>
                                    <th>Schlüssel</th>
                                    <th>Mängel</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for uebergabe in uebergaben_page_obj %}
                                <tr>
                                    <td>{{ uebergabe.uebergabetag|date:"d.m.Y" }}</td>
                                    <td>
                                        {% if uebergabe.typ == 'EINZUG' %}
                                            <span class="badge bg-success">{{ uebergabe.get_typ_display }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">{{ uebergabe.get_typ_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ uebergabe.vertrag.vertragsnummer }}</td>
                                    <td>{{ uebergabe.anzahl_schluessel }}</td>
                                    <td>
                                        {% if uebergabe.maengel %}
                                            <i class="bi bi-exclamation-triangle text-warning"></i> Ja
                                        {% else %}
                                            <i class="bi bi-check-circle text-success"></i> Nein
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        <i class="bi bi-inbox"></i> Keine Übergabeprotokolle vorhanden
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination for Handover Protocols -->
                    {% if uebergaben_page_obj.has_other_pages %}
                    <nav aria-label="Übergaben Pagination">
                        <ul class="pagination pagination-sm">
                            {% if uebergaben_page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?uebergaben_page={{ uebergaben_page_obj.previous_page_number }}#uebergaben">Zurück</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Zurück</span>
                            </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">Seite {{ uebergaben_page_obj.number }} von {{ uebergaben_page_obj.paginator.num_pages }}</span>
                            </li>
                            
                            {% if uebergaben_page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?uebergaben_page={{ uebergaben_page_obj.next_page_number }}#uebergaben">Weiter</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Weiter</span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% endif %}
            </div>
            
            <!-- Images Tab -->
            <div class="tab-pane fade p-3" id="bilder" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Bildergalerie für dieses Mietobjekt</h6>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#bildUploadModal">
                        <i class="bi bi-upload"></i> Bilder hochladen
                    </button>
                </div>
                {% if bilder_page_obj %}
                    {% if bilder_page_obj.object_list %}
                        <div class="row g-3">
                            {% for bild in bilder_page_obj %}
                            <div class="col-md-3 col-sm-4 col-6">
                                <div class="card h-100">
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#bildPreviewModal" data-bs-img-url="{% url 'vermietung:mietobjekt_bild_original' bild.pk %}" data-bs-img-name="{{ bild.original_filename }}" style="cursor: pointer;">
                                        <img src="{% url 'vermietung:mietobjekt_bild_thumbnail' bild.pk %}" class="card-img-top" alt="{{ bild.original_filename }}" style="height: 200px; object-fit: cover;">
                                    </a>
                                    <div class="card-body p-2">
                                        <p class="card-text small mb-1 text-truncate" title="{{ bild.original_filename }}">
                                            <i class="bi bi-image"></i> {{ bild.original_filename }}
                                        </p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">{{ bild.file_size|filesizeformat }}</small>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDeleteBild({{ bild.pk }}, '{{ bild.original_filename|escapejs }}')" title="Löschen">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted d-block">{{ bild.uploaded_at|date:"d.m.Y" }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-images" style="font-size: 3rem;"></i>
                            <p class="mt-2">Keine Bilder vorhanden</p>
                        </div>
                    {% endif %}
                    
                    <!-- Pagination for Images -->
                    {% if bilder_page_obj.has_other_pages %}
                    <nav aria-label="Bilder Pagination" class="mt-3">
                        <ul class="pagination pagination-sm justify-content-center">
                            {% if bilder_page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?bilder_page={{ bilder_page_obj.previous_page_number }}#bilder">Zurück</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Zurück</span>
                            </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">Seite {{ bilder_page_obj.number }} von {{ bilder_page_obj.paginator.num_pages }}</span>
                            </li>
                            
                            {% if bilder_page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?bilder_page={{ bilder_page_obj.next_page_number }}#bilder">Weiter</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Weiter</span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% endif %}
            </div>
            
            <!-- Documents Tab -->
            <div class="tab-pane fade p-3" id="dokumente" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Dokumente für dieses Mietobjekt</h6>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="bi bi-upload"></i> Dokument hochladen
                    </button>
                </div>
                {% if dokumente_page_obj %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Dateiname</th>
                                    <th>Größe</th>
                                    <th>Typ</th>
                                    <th>Hochgeladen</th>
                                    <th>Von</th>
                                    <th class="text-end">Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dokument in dokumente_page_obj %}
                                <tr>
                                    <td>
                                        <i class="bi bi-file-earmark"></i> {{ dokument.original_filename }}
                                        {% if dokument.beschreibung %}
                                        <br><small class="text-muted">{{ dokument.beschreibung|truncatewords:10 }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ dokument.file_size|filesizeformat }}</td>
                                    <td><small class="text-muted">{{ dokument.mime_type }}</small></td>
                                    <td>{{ dokument.uploaded_at|date:"d.m.Y H:i" }}</td>
                                    <td>{{ dokument.uploaded_by.username|default:"-" }}</td>
                                    <td class="text-end">
                                        <a href="{% url 'vermietung:dokument_download' dokument.pk %}" class="btn btn-sm btn-outline-info" title="Herunterladen">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDeleteDokument({{ dokument.pk }}, '{{ dokument.original_filename|escapejs }}')" title="Löschen">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <i class="bi bi-inbox"></i> Keine Dokumente vorhanden
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination for Documents -->
                    {% if dokumente_page_obj.has_other_pages %}
                    <nav aria-label="Dokumente Pagination">
                        <ul class="pagination pagination-sm">
                            {% if dokumente_page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?dokumente_page={{ dokumente_page_obj.previous_page_number }}#dokumente">Zurück</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Zurück</span>
                            </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">Seite {{ dokumente_page_obj.number }} von {{ dokumente_page_obj.paginator.num_pages }}</span>
                            </li>
                            
                            {% if dokumente_page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?dokumente_page={{ dokumente_page_obj.next_page_number }}#dokumente">Weiter</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Weiter</span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<form id="deleteForm" method="post" action="{% url 'vermietung:mietobjekt_delete' mietobjekt.pk %}" style="display: none;">
    {% csrf_token %}
</form>

<!-- Document Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">
                    <i class="bi bi-upload"></i> Dokument hochladen
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'vermietung:dokument_upload' 'mietobjekt' mietobjekt.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="id_file" class="form-label">Datei *</label>
                        <input type="file" class="form-control" id="id_file" name="file" required accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.docx">
                        <div class="form-text">
                            Erlaubte Dateitypen: PDF, PNG, JPG/JPEG, GIF, WebP, DOCX. Maximale Größe: 10 MB
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="id_beschreibung" class="form-label">Beschreibung (optional)</label>
                        <textarea class="form-control" id="id_beschreibung" name="beschreibung" rows="3" placeholder="Optional: Beschreibung des Dokuments"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload"></i> Hochladen
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Image Upload Modal -->
<div class="modal fade" id="bildUploadModal" tabindex="-1" aria-labelledby="bildUploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="bildUploadModalLabel">
                    <i class="bi bi-images"></i> Bilder hochladen
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'vermietung:mietobjekt_bild_upload' mietobjekt.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="id_bilder" class="form-label">Bilder *</label>
                        <input type="file" class="form-control" id="id_bilder" name="bilder" required multiple accept="image/png,image/jpeg,image/gif,image/webp,.png,.jpg,.jpeg,.gif,.webp">
                        <div class="form-text">
                            Erlaubte Bildtypen: PNG, JPG/JPEG, GIF, WebP. Maximale Größe: 10 MB pro Bild. Sie können mehrere Bilder gleichzeitig auswählen.
                        </div>
                    </div>
                    <div id="imagePreviewContainer" class="row g-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload"></i> Hochladen
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="bildPreviewModal" tabindex="-1" aria-labelledby="bildPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="bildPreviewModalLabel">Bildvorschau</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="previewImage" src="" alt="" class="img-fluid" style="max-height: 70vh;">
            </div>
        </div>
    </div>
</div>

<form id="deleteBildForm" method="post" action="" style="display: none;">
    {% csrf_token %}
</form>

<form id="deleteDokumentForm" method="post" action="" style="display: none;">
    {% csrf_token %}
</form>
{% endblock %}

{% block extra_js %}
<script>
// Tab state management using localStorage
(function() {
    const TAB_STORAGE_KEY = 'mietobjekt_detail_active_tab';
    // Whitelist of valid tab IDs to prevent XSS
    const VALID_TABS = ['vertraege', 'uebergaben', 'bilder', 'dokumente'];
    
    // Safe localStorage wrapper
    function safeGetItem(key) {
        try {
            return localStorage.getItem(key);
        } catch (e) {
            console.warn('localStorage.getItem failed:', e);
            return null;
        }
    }
    
    function safeSetItem(key, value) {
        try {
            localStorage.setItem(key, value);
        } catch (e) {
            console.warn('localStorage.setItem failed:', e);
        }
    }
    
    // Validate tab ID against whitelist
    function isValidTab(tabId) {
        return tabId && VALID_TABS.indexOf(tabId) !== -1;
    }
    
    // Restore active tab on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Check if there's a hash in the URL (from pagination links)
        let tabToActivate = null;
        if (window.location.hash) {
            const hashTab = window.location.hash.substring(1); // Remove '#'
            // Validate against whitelist before using
            if (isValidTab(hashTab)) {
                // Verify this tab element exists in DOM
                if (document.getElementById(hashTab)) {
                    tabToActivate = hashTab;
                    // Save this to localStorage as well
                    safeSetItem(TAB_STORAGE_KEY, tabToActivate);
                }
            }
        }
        
        // If no hash, check localStorage
        if (!tabToActivate) {
            const savedTab = safeGetItem(TAB_STORAGE_KEY);
            // Validate saved tab against whitelist
            if (isValidTab(savedTab)) {
                tabToActivate = savedTab;
            }
        }
        
        // Activate the tab if we have one
        if (tabToActivate) {
            const tabButton = document.querySelector('#relatedTabs button[data-bs-target="#' + tabToActivate + '"]');
            const tabPane = document.getElementById(tabToActivate);
            
            if (tabButton && tabPane) {
                // Remove active class from all tabs
                document.querySelectorAll('#relatedTabs .nav-link').forEach(function(tab) {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('#relatedTabsContent .tab-pane').forEach(function(pane) {
                    pane.classList.remove('show', 'active');
                });
                
                // Activate the saved tab
                tabButton.classList.add('active');
                tabPane.classList.add('show', 'active');
            }
        }
        
        // Save tab state when user clicks on a tab
        document.querySelectorAll('#relatedTabs button[data-bs-toggle="tab"]').forEach(function(tabButton) {
            tabButton.addEventListener('shown.bs.tab', function(event) {
                const targetTab = event.target.getAttribute('data-bs-target').substring(1); // Remove '#'
                // Validate before saving
                if (isValidTab(targetTab)) {
                    safeSetItem(TAB_STORAGE_KEY, targetTab);
                }
            });
        });
    });
})();

function confirmDelete() {
    if (confirm('Möchten Sie das Mietobjekt "{{ mietobjekt.name }}" wirklich löschen?')) {
        document.getElementById('deleteForm').submit();
    }
}

function confirmDeleteDokument(dokumentId, filename) {
    if (confirm('Möchten Sie das Dokument "' + filename + '" wirklich löschen?\n\nDieser Vorgang kann nicht rückgängig gemacht werden.')) {
        var form = document.getElementById('deleteDokumentForm');
        form.action = "{% url 'vermietung:dokument_delete' 0 %}".replace('/0/', '/' + dokumentId + '/');
        form.submit();
    }
}

function confirmDeleteBild(bildId, filename) {
    if (confirm('Möchten Sie das Bild "' + filename + '" wirklich löschen?\n\nDieser Vorgang kann nicht rückgängig gemacht werden.')) {
        var form = document.getElementById('deleteBildForm');
        form.action = "{% url 'vermietung:mietobjekt_bild_delete' 0 %}".replace('/0/', '/' + bildId + '/');
        form.submit();
    }
}

// Image preview in modal
document.addEventListener('DOMContentLoaded', function() {
    var bildPreviewModal = document.getElementById('bildPreviewModal');
    if (bildPreviewModal) {
        bildPreviewModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var imgUrl = button.getAttribute('data-bs-img-url');
            var imgName = button.getAttribute('data-bs-img-name');
            
            var modalImage = document.getElementById('previewImage');
            var modalTitle = document.getElementById('bildPreviewModalLabel');
            
            modalImage.src = imgUrl;
            modalImage.alt = imgName;
            modalTitle.textContent = imgName;
        });
    }
    
    // Show image previews when files are selected
    var fileInput = document.getElementById('id_bilder');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            var container = document.getElementById('imagePreviewContainer');
            container.innerHTML = '';
            
            var files = Array.from(e.target.files);
            if (files.length > 0) {
                files.forEach(function(file, index) {
                    if (file.type.startsWith('image/')) {
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            var col = document.createElement('div');
                            col.className = 'col-4';
                            var img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'img-thumbnail';
                            img.style.height = '100px';
                            img.style.objectFit = 'cover';
                            col.appendChild(img);
                            container.appendChild(col);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });
    }
});
</script>
{% endblock %}
