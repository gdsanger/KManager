{% load static %}

<!-- Quill CSS -->
<link href="{% static 'quill/quill.snow.css' %}" rel="stylesheet">
<style>
    #longTextEditor {
        height: 200px;
        background-color: var(--bs-body-bg);
    }
    .ql-toolbar {
        background-color: var(--bs-secondary-bg);
        border-color: var(--bs-border-color);
    }
    .ql-container {
        border-color: var(--bs-border-color);
    }
</style>

<form id="itemEditForm">
    {% csrf_token %}
    <input type="hidden" name="item_id" value="{{ item.pk }}">
    
    <!-- Basic Information Section -->
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="{{ form.article_no.id_for_label }}" class="form-label">{{ form.article_no.label }}</label>
                {{ form.article_no }}
                <div class="invalid-feedback"></div>
            </div>

            <div class="mb-3">
                <label for="{{ form.short_text_1.id_for_label }}" class="form-label">{{ form.short_text_1.label }}</label>
                {{ form.short_text_1 }}
                <div class="invalid-feedback"></div>
            </div>

            <div class="mb-3">
                <label for="{{ form.short_text_2.id_for_label }}" class="form-label">{{ form.short_text_2.label }}</label>
                {{ form.short_text_2 }}
                <div class="invalid-feedback"></div>
            </div>

            <div class="mb-3">
                <label for="{{ form.item_type.id_for_label }}" class="form-label">{{ form.item_type.label }}</label>
                {{ form.item_type }}
                <div class="invalid-feedback"></div>
            </div>

            <div class="mb-3">
                <label for="{{ form.item_group.id_for_label }}" class="form-label">{{ form.item_group.label }}</label>
                {{ form.item_group }}
                <div class="invalid-feedback"></div>
            </div>
        </div>

        <!-- Pricing and Cost Section -->
        <div class="col-md-6">
            <div class="mb-3">
                <label for="{{ form.net_price.id_for_label }}" class="form-label">{{ form.net_price.label }}</label>
                <div class="input-group">
                    {{ form.net_price }}
                    <span class="input-group-text">€</span>
                </div>
                <div class="invalid-feedback"></div>
            </div>

            <div class="mb-3">
                <label for="{{ form.purchase_price.id_for_label }}" class="form-label">{{ form.purchase_price.label }}</label>
                <div class="input-group">
                    {{ form.purchase_price }}
                    <span class="input-group-text">€</span>
                </div>
                <div class="invalid-feedback"></div>
            </div>

            <div class="mb-3">
                <label for="{{ form.tax_rate.id_for_label }}" class="form-label">{{ form.tax_rate.label }}</label>
                {{ form.tax_rate }}
                <div class="invalid-feedback"></div>
            </div>

            <div class="mb-3">
                <label for="{{ form.cost_type_1.id_for_label }}" class="form-label">{{ form.cost_type_1.label }}</label>
                <select name="{{ form.cost_type_1.name }}" 
                        class="form-select" 
                        id="{{ form.cost_type_1.id_for_label }}"
                        hx-get="{% url 'cost_type_2_options' %}"
                        hx-target="#cost-type-2-wrapper"
                        hx-trigger="change"
                        {% if form.cost_type_1.field.required %}required{% endif %}>
                    <option value="">---------</option>
                    {% for pk, label in form.cost_type_1.field.choices %}
                        {% if pk %}
                        <option value="{{ pk }}" {% if form.cost_type_1.value == pk|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                {% if form.cost_type_1.help_text %}
                <div class="form-text">{{ form.cost_type_1.help_text }}</div>
                {% endif %}
                <div class="invalid-feedback"></div>
            </div>

            <div class="mb-3">
                {% include 'core/partials/cost_type_2_select.html' %}
            </div>

            <div class="mb-3 form-check">
                {{ form.is_discountable }}
                <label for="{{ form.is_discountable.id_for_label }}" class="form-check-label">{{ form.is_discountable.label }}</label>
            </div>

            <div class="mb-3 form-check">
                {{ form.is_active }}
                <label for="{{ form.is_active.id_for_label }}" class="form-check-label">{{ form.is_active.label }}</label>
            </div>
        </div>
    </div>

    <!-- Long Text Section - Full Width at Bottom -->
    <div class="row">
        <div class="col-12">
            <div class="mb-3">
                <label for="{{ form.long_text.id_for_label }}" class="form-label">{{ form.long_text.label }}</label>
                <!-- Quill Editor Container -->
                <div id="longTextEditor"></div>
                <!-- Hidden field to store content - keep original form field but hide it -->
                <textarea name="{{ form.long_text.name }}" id="{{ form.long_text.id_for_label }}" style="display: none;" aria-hidden="true">{{ form.long_text.value|default:'' }}</textarea>
                <div class="invalid-feedback"></div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" id="cancelItemEdit">
            <i class="bi bi-x"></i> Abbrechen
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-save"></i> Speichern
        </button>
    </div>
</form>

<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<!-- Quill JS -->
<script src="{% static 'quill/quill.js' %}"></script>
<script>
// Initialize Quill editor for long_text
(function() {
    const quill = new Quill('#longTextEditor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],        // toggled buttons
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],  // lists
                ['link'],                                // link
                ['clean']                                // remove formatting
            ]
        },
        placeholder: 'Langtext eingeben...'
    });
    
    // Load initial content from the hidden textarea
    const hiddenTextarea = document.getElementById('{{ form.long_text.id_for_label }}');
    const initialContent = hiddenTextarea.value || '';
    if (initialContent) {
        quill.root.innerHTML = initialContent;
    }
    
    // Update hidden textarea on text change
    quill.on('text-change', function() {
        hiddenTextarea.value = quill.root.innerHTML;
    });
})();

// Attach cancel handler
document.getElementById('cancelItemEdit').addEventListener('click', function() {
    document.getElementById('itemModalClose').click();
});
</script>
